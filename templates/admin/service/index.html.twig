{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des Services{% endblock %}

{% macro sortable_link(label, field, current_sort, current_direction) %}
    {% set new_direction = (current_sort == field and current_direction == 'asc') ? 'desc' : 'asc' %}
    {% set query_params = app.request ? app.request.query.all : {} %}
    <a href="{{ path('admin_service_index', query_params|merge({sort: field, direction: new_direction, page: 1})) }}">
        {{ label }}
        {% if current_sort == field %}
            <i class="fas fa-sort-{{ current_direction == 'asc' ? 'up' : 'down' }}"></i>
        {% endif %}
    </a>
{% endmacro %}

{% block body %}
    <h1>Gestion des Services</h1>

    <form action="{{ path('admin_service_index') }}" method="get" class="mb-3">
        <div class="row">
            <div class="col-md-4">
                <div class="input-group">
                     {{ form_widget(search_form.q, {'attr': {'placeholder': 'Rechercher...'}}) }}
                     <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
                </div>
                 {{ form_rest(search_form) }}
            </div>
            <div class="col-md-3">
                 <select name="site_id" class="form-select" onchange="this.form.submit()">
                    <option value="">Tous les sites</option>
                    {% for site in sites %}
                        <option value="{{ site.id }}" {{ site.id == current_site_id ? 'selected' : '' }}>{{ site.nom }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                 <select name="etage_id" class="form-select" onchange="this.form.submit()">
                    <option value="">Tous les étages</option>
                    {% for etage in etages %}
                        <option value="{{ etage.id }}" {{ etage.id == current_etage_id ? 'selected' : '' }}>{{ etage.nom }} ({{ etage.site.nom }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 text-end">
                <a href="{{ path('admin_service_new') }}" class="btn btn-primary">Créer un service</a>
            </div>
        </div>
    </form>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>{{ _self.sortable_link('ID', 's.id', sort, direction) }}</th>
                <th>{{ _self.sortable_link('Nom', 's.nom', sort, direction) }}</th>
                <th>{{ _self.sortable_link('Étage', 'e.nom', sort, direction) }}</th>
                <th>{{ _self.sortable_link('Site', 'si.nom', sort, direction) }}</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for service in services %}
            <tr>
                <td>{{ service.id }}</td>
                <td>{{ service.nom }}</td>
                <td><a href="{{ path('admin_etage_show', {'id': service.etage.id}) }}">{{ service.etage.nom }}</a></td>
                <td><a href="{{ path('admin_site_show', {'id': service.etage.site.id}) }}">{{ service.etage.site.nom }}</a></td>
                <td>
                    <a href="{{ path('admin_service_show', {'id': service.id}) }}" class="btn btn-sm btn-info" title="Voir"><i class="fas fa-eye"></i></a>
                    <a href="{{ path('admin_service_edit', {'id': service.id}) }}" class="btn btn-sm btn-warning" title="Modifier"><i class="fas fa-pencil-alt"></i></a>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="5" class="text-center">Aucun service trouvé.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if maxPage > 1 %}
        <nav>
            <ul class="pagination">
                <li class="page-item {{ page <= 1 ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path('admin_service_index', (app.request ? app.request.query.all : {})|merge({page: page - 1})) }}">Précédent</a>
                </li>
                {% for i in 1..maxPage %}
                    <li class="page-item {{ i == page ? 'active' : '' }}">
                        <a class="page-link" href="{{ path('admin_service_index', (app.request ? app.request.query.all : {})|merge({page: i})) }}">{{ i }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {{ page >= maxPage ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path('admin_service_index', (app.request ? app.request.query.all : {})|merge({page: page + 1})) }}">Suivant</a>
                </li>
            </ul>
        </nav>
    {% endif %}
{% endblock %}
